# 逻辑层(App Service)

小程序开发框架的逻辑层由 JavaScript 编写。

逻辑层将数据进行处理后发送给视图层，同时接受视图层的事件反馈。

在 JavaScript 的基础上，我们做了一些修改，以方便地开发小程序。
 * 增加 `App` 和 `Page` 方法，进行程序和页面的注册。
 * 增加 `getApp` 和 `getCurrentPages` 方法，分别用来获取 `App` 实例和当前页面栈。
 * 提供丰富的 API，如微信用户数据，扫一扫，支付等微信特有能力。
 * 每个页面有独立的作用域，并提供模块化能力。
 * 由于框架并非运行在浏览器中，所以 JavaScript 在 web 中一些能力都无法使用，如 `document`，`window` 等。
 * 开发者写的所有代码最终将会打包成一份 JavaScript，并在小程序启动的时候运行，直到小程序销毁。类似 ServiceWorker，所以逻辑层也称之为 App Service。

## 1. App

### 1.1 App()

 `App()` 函数用来注册一个小程序。接受一个 `object` 参数，其指定小程序的生命周期函数等。

 **object参数说明：**

属性 | 类型 | 描述 | 触发时机
- | - | - | -
onLaunch | Function | 生命周期函数--监听小程序初始化 | 当小程序初始化完成时，会触发 onLaunch（全局只触发一次）
onShow | Function | 生命周期函数--监听小程序显示 | 当小程序启动，或从后台进入前台显示，会触发 onShow
onHide | Function | 生命周期函数--监听小程序隐藏 | 当小程序从前台进入后台，会触发 onHide
onError | Function | 错误监听函数 | 当小程序发生脚本错误，或者 api 调用失败时，会触发 onError 并带上错误信息
其他 | Any |  | 开发者可以添加任意的函数或数据到 Object 参数中，用 this 可以访问

**前台、后台定义：** 当用户点击左上角关闭，或者按了设备 Home 键离开微信，小程序并没有直接销毁，而是进入了后台；当再次进入微信或再次打开小程序，又会从后台进入前台。需要注意的是：只有当小程序进入后台一定时间，或者系统资源占用过高，才会被真正的销毁。

关闭小程序（基础库版本1.1.0开始支持）： 当用户从扫一扫、转发等入口(场景值为1007, 1008, 1011, 1025)进入小程序，且没有置顶小程序的情况下退出，小程序会被销毁。

**小程序运行机制在基础库版本 1.4.0 有所改变**： 上一条关闭逻辑在新版本已不适用。[详情](https://mp.weixin.qq.com/debug/wxadoc/dev/framework/operating-mechanism.html)

示例代码：

    App({
        onLaunch: function(options) {
            // Do something initial when launch.
        },
        onShow: function(options) {
            // Do something when show.
        },
        onHide: function() {
            // Do something when hide.
        },
        onError: function(msg) {
            console.log(msg)
        },
        globalData: 'I am global data'
    })

### 1.2 onLaunch, onShow 参数

字段 | 类型 | 说明
- | - | -
path | String | 打开小程序的路径
query | Object | 打开小程序的query
scene | Number | 打开小程序的场景值
shareTicket | String | shareTicket，详见 [获取更多转发信息](https://mp.weixin.qq.com/debug/wxadoc/dev/api/share.html#%E8%8E%B7%E5%8F%96%E6%9B%B4%E5%A4%9A%E8%BD%AC%E5%8F%91%E4%BF%A1%E6%81%AF)
referrerInfo | Object | 当场景为由从另一个小程序或公众号或App打开时，返回此字段
referrerInfo.appId | String | 来源小程序或公众号或App的 appId，详见下方说明
referrerInfo.extraData | Object | 来源小程序传过来的数据，scene=1037或1038时支持

场景值 [详见](https://mp.weixin.qq.com/debug/wxadoc/dev/framework/app-service/scene.html)。

以下场景支持返回 `referrerInfo.appId`：

场景值 | 场景 | appId 信息含义
- | - | -
1020 | 公众号 profile 页相关小程序列表 | 返回来源公众号 appId
1035 | 公众号自定义菜单 | 返回来源公众号 appId
1036 | App 分享消息卡片 | 返回来源应用 appId
1037 | 小程序打开小程序 | 返回来源小程序 appId
1038 | 从另一个小程序返回 | 返回来源小程序 appId
1043 | 公众号模板消息 | 返回来源公众号 appId

### 1.3 getApp()

全局的 `getApp()` 函数可以用来获取到小程序实例。

    // other.js
    var appInstance = getApp()
    console.log(appInstance.globalData) // I am global data

**注意：**
 * `App()` 必须在 `app.js` 中注册，且不能注册多个。
 * 不要在定义于 `App()` 内的函数中调用 `getApp()` ，使用 `this` 就可以拿到 `app` 实例。
 * 不要在 `onLaunch` 的时候调用 `getCurrentPages()`，此时 `page` 还没有生成。
 * 通过 `getApp()` 获取实例之后，不要私自调用生命周期函数。

## 2. 场景值

>基础库 1.1.0 开始支持，低版本需做[兼容处理](https://mp.weixin.qq.com/debug/wxadoc/dev/framework/compatibility.html)

当前支持的场景值有：

场景值ID | 说明
- | -
1001 | 发现栏小程序主入口
1005 | 顶部搜索框的搜索结果页
1006 | 发现栏小程序主入口搜索框的搜索结果页
1007 | 单人聊天会话中的小程序消息卡片
1008 | 群聊会话中的小程序消息卡片
1011 | 扫描二维码
1012 | 长按图片识别二维码
1013 | 手机相册选取二维码
1014 | 小程序模版消息
1017 | 前往体验版的入口页
1019 | 微信钱包
1020 | 公众号 profile 页相关小程序列表
1022 | 聊天顶部置顶小程序入口
1023 | 安卓系统桌面图标
1024 | 小程序 profile 页
1025 | 扫描一维码
1026 | 附近小程序列表
1027 | 顶部搜索框搜索结果页“使用过的小程序”列表
1028 | 我的卡包
1029 | 卡券详情页
1030 | 自动化测试下打开小程序
1031 | 长按图片识别一维码
1032 | 手机相册选取一维码
1034 | 微信支付完成页
1035 | 公众号自定义菜单
1036 | App 分享消息卡片
1037 | 小程序打开小程序
1038 | 从另一个小程序返回
1039 | 摇电视
1042 | 添加好友搜索框的搜索结果页
1043 | 公众号模板消息
1044 | 带 shareTicket 的小程序消息卡片（详情)
1047 | 扫描小程序码
1048 | 长按图片识别小程序码
1049 | 手机相册选取小程序码
1052 | 卡券的适用门店列表
1053 | 搜一搜的结果页
1054 | 顶部搜索框小程序快捷入口
1056 | 音乐播放器菜单
1057 | 钱包中的银行卡详情页
1058 | 公众号文章
1059 | 体验版小程序绑定邀请页
1064 | 微信连Wi-Fi状态栏
1067 | 公众号文章广告
1068 | 附近小程序列表广告
1071 | 钱包中的银行卡列表页
1072 | 二维码收款页面
1073 | 客服消息列表下发的小程序消息卡片
1074 | 公众号会话下发的小程序消息卡片
1078 | 连Wi-Fi成功页
1089 | 微信聊天主界面下拉
1090 | 长按小程序右上角菜单唤出最近使用历史
1092 | 城市服务入口

可以在 `App` 的 `onlaunch` 和 `onshow` 中获取上述场景值，部分场景值下还可以获取来源应用、公众号或小程序的`appId`。[详见](https://mp.weixin.qq.com/debug/wxadoc/dev/framework/app-service/app.html)

**Tip:** 由于Android系统限制，目前还无法获取到按 Home 键退出到桌面，然后从桌面再次进小程序的场景值，对于这种情况，会保留上一次的场景值。

