# 2.5 IP 与以太网的包收发操作

## 2.5.1 包的基本知识

TCP 模块在执行连接、收发、断开等各阶段操作时,都需要􏰀托 IP 模块将数据封装成包发送给通信对象。
我们在 TCP 的讲解中也经常提到 IP, 下面就来讨论一下 IP 模块是如何将包发送给对方的。

正式开始这个话题之前,我们先来介绍一下关于网络包的一些基本知识。

[图 2.14 网络包的结构](images/2.14.png)

首先,包是由头部和数据两部分构成的(图 2.14(a)。
头部包含目的地址等控制信息,大家可以把它理解为快递包裹的快递单;
头部后面就是􏰀委托方要发送给对方的数据,也就相当于快递包裹里的货物。

一个包发往目的地的过程如图 2.15 所示。

[图 2.15 发送方、接收方和转发设备](images/2.15.png)

首先,发送方的网络设备会负责创建包,
创建包的过程就是生成含有正确控制信息的头部,然后再附加上要发送的数据。

接下来,包会被发往最近的网络转发设备。

当到达最近的转发设备之后,转发设备会根据头部中的信息判断接下来应该发往哪里。

这个过程需要用到一张表,这张表里面记录了每一个地址对应的发送方向,
也就是按照头部里记录的目的地址在表里进行查询,
并根据查到的信息判断接下来应该发往哪个方向。

比如, 如果查表的结果是“目标地址为 ×××× 的包应该发到 ×××× 号线路”,
那么转发设备就会把这个包发到 ×××× 号线路去。

接下来,包在向目的地移动的过程中,又会到达下一个转发设备,
然后又会按照同样的方式被发往下一个转发设备。

就这样,经过多个转发设备的接力之后,包最终就会到达接收方的网络设备。

当然,发送方 向 接收方 发送一个包,接收方可能也会向发送方返回一个包,
此时的发送方到了接下来的某个时刻就会变成接收方。

因此,我们不需要把发送方和接收方明确区分开来,在这里我们把发送方和接收方统称为终端节点。
（相应地,转发设备被称为转发节点或者中间节点。）

前面介绍的这些基本知识,对于各种通信方式都是适用的,当然也适用于 TCP/IP 网络。

不过,TCP/IP 包的结构是在这个基本结构的基础上扩展出来的,因此更加复杂。

在第 1 章 1.2.1 节,我们讲过子网的概念,
还讲过网络中有路由器和集线器两种不同的转发设备,
它们在传输网络包时有着各自的分工。
 1. 路由器根据目标地址判断下一个路由器的位置
 2. 集线器在子网中将网络包传输到下一个路由

实际上,集线器是按照以太网规则传输包的设备,
而路由器是按照 IP 规则传输包的设备,因此我们也可以作如下理解。
 1. IP 协议根据目标地址判断下一个 IP 转发设备的位置
 2. 子网中的以太网协议将包传输到下一个转发设备

具体来说,如图 2.14(b)所示,TCP/IP 包包含如下两个头部。
 1. MAC 头部(用于以太网协议)
 2. IP 头部(用于 IP 协议)

这两个头部分别具有不同的作用。

[图 2.16 IP 网络包的传输方式](images/2.16.png)

首先,发送方将包的目的地,也就是要访问的服务器的 IP 地址写入 IP 头部中。

这样一来,我们就知道这个包应该发往哪里,IP 协议就可以根据这一地址查找包的传输方向,
从而找到下一个路由器的位置,也就是图 2.16 中的路由器 R1。

接下来,IP 协议会委􏰀托以太网协议将包传输过去。
这时,IP 协议会查找下一个路由器的以太网地址(MAC 地址),并将这个地址写入 MAC 头部中。
这样一来,以太网协议就知道要将这个包发到哪一个路由器上了。

网络包在传输过程中(图 2.16 ①)会经过集线器,集线器是根据以太网协议工作的设备。

为了判断包接下来应该向什么地方传输,集线器里有一张表(用于以太网协议的表),
可根据以太网头部中记录的目的地信息查出相应的传输方向。

这张图中只有一个集线器,当存在多个集线器时,网络包会按顺序逐一通过这些集线器进行传输。

接下来,包会到达下一个路由器(图 2.16 ②)。
路由器中有一张 IP 协议的表,
可根据这张表以及 IP 头部中记录的目的地信息查出接下来应该发往哪个路由器。

为了将包发到下一个路由器,我们还需要查出下一个路由器的 MAC 地址,
并记录到 MAC 头部中,大家可以理解为改写了 MAC 头部。
（更准确地说,收到包的时候 MAC 头部会被舍弃,而当再次发送的时候又会加上包含新 MAC 地址的新 MAC 头部。）

这样,网络包就又被发往下一个节点了。

再往后的过程图上就没有画出来了。
网络包会通过路由器到达下一个路由器 R2。
这个过程不断重复,最终网络包就会被送到目的地,当目的地设备成功接收之后,网络包的传输过程就结束了。

前面介绍的就是在 TCP/IP 网络中,一个网络包从出发 到 到达目的地 的全过程。

虽然看起来有点复杂,不过设计这样的分工是有原因的。
前面讲了 IP 和以太网的分工,其中以太网的部分也可以替换成其他的东西,
例如 无线局域网、ADSL、FTTH 等,
它们都可以替代以太网的角色帮助 IP 协议来传输网络包。
（当使用除以太网之外的其他网络进行传输时,MAC 头部也会被替换为适合所选通信规格的其他头部。）

因此,将 IP 和负责传输的网络分开,可以更好地根据需要使用各种通信技术。

像互联网这样庞大复杂的网络,在架构上需要保证灵活性,这就是设计这种分工方式的原因。