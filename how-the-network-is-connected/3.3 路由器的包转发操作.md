# 3.3  路由器的包转发操作

## 3.3.1 路由器的基本知识


网络包经过集线器和交换机之后，现在到达了路由器，并在此被转发到 下一个路由器。
这一步转发的工作原理和交换机类似，也是通过查表判断包 转发的目标。
不过在具体的操作过程上，路由器和交换机是有区别的。
因为路由器是基于 IP 设计的，而交换机是基于以太网设计的。

IP 和以太网的区别在很多地方都会碰到，我们稍后再具体讲，现在先来看看路由器的概况。

首先，路由器的内部结构如图 3.12 所示。

![图 3.12 路由器的结构](./images/3.12.png)

这张图已经画得非常简略了，大家只要看明白路由器包括转发模块和端口模块两部分就可以了。

其中转发模块负责判断包的转发目的地，端口模块负责包的收发操作。

这一分工模式在第 2 章介绍计算机内部结构的时候也出现过，
换句话说，路由器转发模块和端口模块的关系，就相当于协议栈的 IP 模块和网卡之间的关系。
因此，大家可以将路由器的转发模块想象成 IP 模块，将端口模块想象成网卡。

通过更换网卡，计算机不仅可以支持以太网，也可以支持无线局域网，路由器也是一样。

如果路由器的端口模块安装了支持无线局域网的硬件， 就可以支持无线局域网了。
此外，计算机的网卡除了以太网和无线局域网之外很少见到支持其他通信技术的品种，
而路由器的端口模块则支持除局域网之外的多种通信技术，
如 ADSL、FTTH，以及各种宽带专线等，只要 端口模块安装了支持这些技术的硬件即可。

（从原理上说，计算机只要安装相应的适配器，也可以支持各种通信技术，
但现实中除了局域网之外几乎没有其他需求，因此一般市场上也没有这样的产品。）

看懂了内部结构之后，大家应该能大致理解路由器的工作原理了吧。

路由器在转发包时，首先会通过端口将发过来的包接收进来，
这一步的工作过程取决于端口对应的通信技术。
对于以太网端口来说，就是按照以太网规范进行工作，
而无线局域网端口则按照无线局域网的规范工作，
总之就是 托端口的硬件将包接收进来。

接下来，转发模块会根据接收到的包的 IP 头部中记录的接收方 IP 地址，
在路由表中进行查询，以此判断转发目标。

然后，转发模块将包转移到转发目标对应的端口，端口再按照硬件的规则将包发送出去，
也就是转发模块委托端口模块将包发送出去的意思。

这就是路由器的基本原理，下面再做一些补充。

刚才我们讲到端口模块会根据相应通信技术的规范来执行包收发的操作，
这意味着端口模块是以实际的发送方或者接收方的身份来收发网络包的。

以以太网端口为例， 路由器的端口具有 MAC 地址 ，
（和网卡一样，MAC 地址也是在生产时写入端口的 ROM 中的。）
因此它就能够成为以太网的发送方和接收方 。

端口还具有 IP 地址，从这个意义上来说，它和计算机的网卡是一样的。

当转发包时，首先路由器端口会接收发给自己的以太网包，
（端口是按照以太网规范接收包的，即当端口的 MAC 地址和包的接收方MAC 地址一致时，
端口才接受这个包，否则就丢弃包。），然后查询 转发目标，
再由相应的端口作为发送方将以太网包发送出去。

这一点和交换机是不同的，交换机只是将进来的包转发出去而已，
它自己并不会成为发送方或者接收方。

    路由器的各个端口都具有 MAC 地址和 IP 地址。

## 3.3.2 路由表中的信息

在“查表判断转发目标”这一点上，路由器和交换机的大体思路是类似的，不过具体的工作过程有所不同。

交换机是通过 MAC 头部中的接收方 MAC 地址来判断转发目标的，
而路由器则是根据 IP 头部中的 IP 地址来判断的。

由于使用的地址不同，记录转发目标的表的内容也会不同。

关于细节我们留到后面再讲，现在先来大致介绍一下。
路由器中的表叫作路由表，其中包含的信息如图 3.13 所示。

    路由器根据“IP 地址”判断转发目标。

![图 3.13 路由器根据路由表对包进行转发](./images/3.13.png)

无论是路由器的路由表，还是我们在第 2 章的图 2.18 中展示的计算机中的路由表，
它们的结构和功能都是相同的，只不过每一列的名称可能会有所不同，
这是由于厂商和型号的不同导致的。
不过，为了便于大家理解，我们在这张图上所使用的列名已经和图 2.18 中的列名进行了统一，
因此和实际的路由器中的路由表会有所差异。

最左侧的目标地址列记录的是接收方的信息。
这里可能不是很容易理解，实际上这里的 IP 地址只包含表示子网的网络号部分的比特值，
而表示主机号部分的比特值全部为 0。
（图 3.13 中也有一些 IP 地址的主机号不是全部为 0，
关于这些地址我们稍后会解释，现在请大家先忽略。）

路由器会将接收到的网络包的接收方 IP 地址与路由表中的目标地址进行比较，并找到相应的记录。
交换机在地址表中只匹配完全一致的记录，而路由器则会忽略主机号部分，只匹配网络号部分。
打个比方，路由器在转发包的时候只看接收方地址属于哪个区， ×× 区发往这一边，×× 区发往那一边。

在匹配地址的过程中，路由器需要知道网络号的比特数，因此路由表中还有一列子网掩码。
子网掩码的含义和第 1 章的图 1.9(b)中介绍的子网掩码基本相同，
通过这个值就可以判断出网络号的比特数。

    路由器会忽略主机号，只匹配网络号。

上面这些介绍可以帮助大家大致理解路由器的工作方式，如果要进一步深入，还需要再思考一些问题。

刚才我们说过，目标地址列中的 IP 地址表示的是子网，但也有一些例外，
有时地址本身的子网掩码和路由表中的子网掩码是不一致的，这是路由聚合的结果。

路由聚合会将几个子网合并成一个子网，并在路由表中只产生一条记录。
要搞清楚这个问题，我们还是看一个例子。

![图 3.14 路由聚合](./images/3.14.png)

如图 3.14 所示，我们现在有 3 个子网，
分别为10.10.1.0/24、10.10.2.0/24、10.10.3.0/24，
路由器 B 需要将包发往这 3 个子网。

在这种情况下，路由器 B 的路由表中原本应该有对应这 3 个子网的 3 条记录，
但在这个例子中，无论发往任何一个子网，都是通过路由器 A 来进行转发，
因此我们可以在路由表中将这 3 个子网合并成 10.10.0.0/16，这样也可以正确地进行转发，
但我们减少了路由表中的记录数量，这就是路由聚合。

经过路由聚合，多个子网会被合并成一个子网，子网掩码会发生变化，同时，
目标地址列也会改成聚合后的地址。

相对地，还有另外一些情况，如将一个子网进行细分并注册在路由表中，然后拆分成多条记录。

从结果上看，路由表的子网掩码列只是用来在匹配目标地址时告诉路由器应该匹配多少个比特。
而且，目标地址中的地址和实际子网的网络号可能并不完全相同，但即便如此，路由器依然可以正常工作。

此外，通过上述方法，我们也可以将某台具体计算机的地址写入路由表中，
这时的子网掩码为 255.255.255.255，也就是说地址中的全部 32 个比特都为 1。

这样一来，主机号部分比特全部为 0 可以表示一个子网，
主机号部分比特不全部为 0 可以表示某一台计算机，
两种情况可以用相同的规则来处理。

    路由表的子网掩码列只表示在匹配网络包目标地址时需要对比的比特数量。

关于目标地址和子网掩码我们先讲到这里。
接下来在子网掩码的右边还有网关和接口两列，它们表示网络包的转发目标。

根据目标地址和子网掩码匹配到某条记录后，
路由器就会将网络包交给接口列中指定的网络接口(即端口)B，并转发到网关列中指定的 IP 地址。

最后一列是跃点计数，它表示距离目标 IP 地址的距离是远还是近。
这个数字越小，表示距离目的地越近;数字越大，表示距离目的地越远。

路由表记录维护的方式和交换机也有所不同。
交换机中对 MAC 地址表的维护是包转发操作中的一个步骤，
而路由器中对路由表的维护是与包转发操作相互独立的，也就是说，
在转发包的过程中不需要对路由表的内容进行维护。

对路由表进行维护的方法有几种，大体上可分为以下两类。
 1. 由人手动维护路由记录
 2. 根据路由协议机制，通过路由器之间的信息交换由路由器自行维护路由表的记录

其中(2)中提到的路由协议有很多种，例如 RIP、OSPC、BGP 等都属于路由协议。

### 3.3.3 路由器的包接收操作

下面我们来看一看路由器的整个工作过程。

首先，路由器会接收网络包。路由器的端口有各种不同的类型，
这里我们只介绍以太网端口是如何接收包的。
以太网端口的结构和计算机的网卡基本相同，接收包并存放到缓冲区中的过程也和网卡几乎没有区别。

首先，信号到达网线接口部分，其中的 PHY(MAU)模块和 MAC 模块将信号转换为数字信息，
然后通过包末尾的 FCS 进行错误校验，如果没问题则检查 MAC 头部中的接收方 MAC 地址，
看看是不是发给自己的包，如果是就放到接收缓冲区中，否则就丢弃这个包。

如果包的接收方 MAC 地址不是自己，说明这个包是发给其他设备的，
如果接收这个包就违反了以太网的规则。

路由器的端口都具有 MAC 地址，只接收与自身地址匹配的包，遇到不匹配的包则直接丢弃。